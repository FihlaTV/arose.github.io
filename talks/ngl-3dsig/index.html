<html>
<head>
    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/white.css">
    <style>
        .reveal .slides > section {
            background-color: rgba(255, 255, 255, 0.9);
        }
        .inactive {
            color: #999;
        }
        .warning {
            color: #eea236;
        }
        .success {
            color: #4cae4c;
        }
        .top {
            top: 100px !important;
        }
        .bottom {
            top: unset !important;
            bottom: 100px !important;
        }
        .reveal .speaker-notes {
            width: 50%;
            left: 25%;
        }
    </style>
</head>
<body>
<div class="reveal">
<div class="slides">

<small id="busy" style="display:none; position:absolute; top:0px; right:0px;">Loading...</small>
<div id="viewport" style="width:960px; height:700px;"></div>

<img style="width:79px; height:76px; position:absolute; left:0px; bottom:0px;" src="img/UCSDlogo.jpeg" />
<img style="width:185px; height:44px; position:absolute; right:0px; bottom:0px;" src="img/SDSClogo-plusname-red.jpg" />

<section>
    <h3>Acknowledgements</h3>
    <br/>
    <img class="plain" style="width:50%; float:right;"  src="img/rcsb-team.jpg" />
    <ul style="width:45%; float:left;">
        <li>
            RCSB PDB Team<br/>
            <img class="plain" style="width:60%;" src="img/rcsb_logo.png" />
        </li>
        <li>
            NCI/NIH<br/>
            (U01 CA198942)<br/>
            <img class="plain" src="img/nih-bd2k.png" />
        </li>
    </ul>
</section>

<!-- INTRO -->

<section>
    <h2>Scalable<br/>3D molecular graphics<br/>on the web</h2>
    <div>NGL &amp; MMTF</div>
    <br/>
    <div><small>Alexander Rose @ 3Dsig 2016</small></div>

    <aside class="notes">
        Oh hey, these are some notes. They'll be hidden in your presentation, but you can see them if you open the speaker notes window (hit 's' on your keyboard).
    </aside>
</section>

<section data-state="slide-billion">
    <img class="plain" src="img/1BillionAtomsHorizontal.png" />
    <p>Atoms in the Protein Data Bank (Feb 2016)</p>
</section>

<section data-state="slide-one" class="top">
    <p>Here is one of those atoms.</p>
    <p class="fragment">However they are usually not alone ...</p>
</section>

<section data-state="slide-group" class="top">
    <p>... they come in groups, like this heme ...</p>
</section>

<section data-state="slide-protein" class="top">
    <p>... and form proteins ...</p>
</section>

<section data-state="slide-complex" class="top">
    <p>... as well as large complexes ...</p>
</section>

<section data-state="slide-complex" class="bottom">
    <p>... are those (becoming) too big for browsers?</p>
</section>

<section data-state="slide-status">
    <h3>Status Quo PDB archive</h3>
    <ul>
        <li>Largest structure: HIV-1 Capsid</li>
        <ul>
            <li>~2.4M unique atoms</li>
            <li>gzipped mmCIF file: 48.7MB</li>
        </ul>
    </ul>
    <p>
        <ul class="fragment">
            <li>68 of the 100 largest structures<br/>deposited in past 3 years</li>
        </ul>
    </p>
    <br/>
    <p class="fragment">How to display such structures in a web-browser?</p>
</section>

<section>
    <h3>Steps to display a structure</h3>
    <img class="plain" style="float:right; width:15%; margin-right:5%" src="img/transmission.png" />
    <ol>
        <li class="inactive">Retrieve File</li>
        <li class="inactive">Parse File</li>
        <li class="inactive">Create Data Model</li>
        <li class="inactive">Create Geometry</li>
        <li class="inactive">Render</li>
    </ol>
</section>



<!-- RETRIEVAL & PARSING -->

<section>
    <h3>Retrieval &amp; Parsing</h3>
    <ol>
        <li class="warning">Retrieve File &#10144; ???</li>
        <li class="warning">Parse File &#10144; ???</li>
        <li class="inactive">Create Data Model</li>
        <li class="inactive">Create Geometry</li>
        <li class="inactive">Render</li>
    </ol>
</section>

<section>
    <h3>Speeding-up<br/>Retrieval &amp; Parsing</h3>
    <ul>
        <li class="fragment">Retrieval: Smaller file-size</li>
        <li class="fragment">Parsing: Binary encoding</li>
        <li class="fragment">Consistent &amp; complete data</li>
    </ul>
    <p class="fragment">&#10144; A new file format for transmission?</p>
</section>

<section>
    <h3>MacroMolecular<br/>Transmission Format (MMTF)</h3>
    <ul>
        <li class="fragment">Binary (MessagePack as a container)</li>
        <li class="fragment">Bespoke compression strategies:</li>
            <small>
                <ul class="fragment">
                    <li>Dictionary encoding</li>
                    <li>Run-length encoding</li>
                    <li>Integer encoding</li>
                    <li>Delta encoding</li>
                    <li>Integer packing (recursive indexing)</li>
                </ul>
            </small>
        </li>
    </ul>
</section>

<section>
    <h3>MMTF compared to mmCIF</h3>
    <img class="plain" style="width:50%;"  src="img/mmtf-file-size.png" />
    <p><small>File size of the whole archive when gzip compressed</small></p>
</section>

<section>
    <h3>MMTF compared to mmCIF</h3>
    <img class="plain" style="width:50%;"  src="img/mmtf-parsing-time.png" />
    <p><small>Parsing time of the whole archive on a 2.6 GHz Intel Core i5 using Java</small></p>
</section>

<section>
    <h3>MMTF - Included Data Fields</h3>
    <ul>
        <li>Model/chain/group/atom names and ids</li>
        <li>Coordinates &amp; B-factors</li>
        <li>Complete bonding data</li>
        <li>DSSP secondary structure</li>
        <li>and more ...</li>
    </ul>
</section>

<section>
    <h3>MMTF - Flavors</h3>
    <ul>
        <li class="fragment">Full:
            <ul>
                <li>All atoms</li>
                <li>Three decimal place precision</li>
            </ul>
        </li>
        <li class="fragment">Reduced:
            <ul>
                <li>C-alpha/phosphate &amp; ligand atoms</li>
                <li>One decimal place precision</li>
            </ul>
        </li>
        <li class="fragment">Build your own:
            <ul>
                <li>Specification: required &amp; optional fields</li>
                <li>Planned: user data fields</li>
            </ul>
        </li>
    </ul>
</section>

<section>
    <h3>MMTF - Availability</h3>
    <div style="width:8%; right:0px; position:absolute;">
        <img class="plain" style="margin:0px" src="img/java.png" />
        <img class="plain" style="margin:15px 0px 15px 0px" src="img/javascript.png" />
        <img class="plain" style="margin:0px" src="img/python.png" />
    </div>
    <ul>
        <li>
            Open specification and libraries:<br/>
            Java, JavaScript, Python, (C/C++ planned)
        </li>
        <li class="fragment">
            Weekly updated PDB archive:<br/>
            full &amp; reduced flavor
        </li>
    </ul>
    <p class="fragment">
        Details at http://mmtf.rcsb.org/ and<br/>
        on posters ...
    </p>
</section>

<section>
    <h3>Retrieval &amp; Parsing</h3>
    <ol>
        <li class="success">Retrieve File &#10144; MMTF</li>
        <li class="success">Parse File &#10144; MMTF</li>
        <li class="inactive">Create Data Model</li>
        <li class="inactive">Create Geometry</li>
        <li class="inactive">Render</li>
    </ol>
</section>



<!-- DATA MODEL -->

<section>
    <h3>Efficient Storage &amp; Access</h3>
    <ol>
        <li class="inactive">Retrieve File &#10144; MMTF</li>
        <li class="inactive">Parse File &#10144; MMTF</li>
        <li class="warning">Create Data Model &#10144; ???</li>
        <li class="inactive">Create Geometry</li>
        <li class="inactive">Render</li>
    </ol>
</section>

<section>
    <h3>Data Model Wish-list</h3>
    <ul>
        <li class="fragment">Fast creation from parsed file</li>
        <li class="fragment">Memory efficient</li>
        <li class="fragment">
            Convenient access<br/>
            (e.g. of atom/residue level data)
        </li>
    </ul>
</section>

<section>
    <h3>NGL Data Model</h3>
    <ul>
        <li class="fragment">Columnar stores</li>
        <li class="fragment">Single TypedArray per property</li>
        <li class="fragment">Parsed data can be copied in blocks</li>
        <li class="fragment">Convenient access via proxy objects</li>
    </ul>
</section>

<section>
    <h3>NGL Data Model</h3>
    <img class="plain" style="width:60%;"  src="img/ngl-store-proxy.png" />
</section>

<section>
    <h3>Efficient Storage &amp; Access</h3>
    <ol>
        <li class="inactive">Retrieve File &#10144; MMTF</li>
        <li class="inactive">Parse File &#10144; MMTF</li>
        <li class="success">Create Data Model &#10144; Columnar Stores</li>
        <li class="inactive">Create Geometry</li>
        <li class="inactive">Render</li>
    </ol>
</section>



<!-- GEOMETRY -->

<section>
    <h3>Geometry</h3>
    <ol>
        <li class="inactive">Retrieve File &#10144; MMTF</li>
        <li class="inactive">Parse File &#10144; MMTF</li>
        <li class="inactive">Create Data Model &#10144; Columnar Stores</li>
        <li class="warning">Create Geometry &#10144; ???</li>
        <li class="inactive">Render</li>
    </ol>
</section>

<section>
    <h3>Impostors</h3>
    <small>
        Impostors: For each pixel let GPU test intersection of sphere and camera ray.<br/>
        Quality resolution independent. Also available for cylinders.
    </small>
    <img class="plain" style="width:75%;"  src="img/impostor.png" />
</section>

<section>
    <h3>Instancing</h3>
    <img class="plain" style="float:left; width:44%;"  src="img/instances.png" />
    <p style="width:40%;">
        <br/>
        <ul>
            <li>Create geometry once</li>
            <li>Send to GPU once</li>
            <li>
                Transform position &amp;<br/>
                render multiple times
            </li>
        </ul>
        <br/><br/>
        <small>
            &#8678; Green surface is reused 59 times<br/>
            for highly symmetric virus capsid<br/>
            (PDB ID 1RB8)
        </small>
    </p>
</section>

<section>
    <h3>Geometry</h3>
    <ol>
        <li class="inactive">Retrieve File &#10144; MMTF</li>
        <li class="inactive">Parse File &#10144; MMTF</li>
        <li class="inactive">Create Data Model &#10144; Columnar Stores</li>
        <li class="success">Create Geometry &#10144; Impostors &amp; Instancing</li>
        <li class="inactive">Render</li>
    </ol>
</section>



<!-- RENDERING -->

<section>
    <h3>3D Rendering</h3>
    <ol>
        <li class="inactive">Retrieve File &#10144; MMTF</li>
        <li class="inactive">Parse File &#10144; MMTF</li>
        <li class="inactive">Create Data Model &#10144; Columnar Stores</li>
        <li class="inactive">Create Geometry &#10144; Impostors &amp; Instancing</li>
        <li class="warning">Render &#10144; ???</li>
    </ol>
</section>

<section>
    <h3>Java Applet Deprecation</h3>
    <img class="plain" style="width:30%; float:right;" src="img/java-applet.png" />
    <ul>
        <li>
            Java Applets have provided<br/>
            fast execution and GPU access
        </li>
        <div class="fragment">
            <li>
                Removed from Google Chrome<br/>
                in version 45 (Sep 2015)
            </li>
            <li>
                Oracle to deprecate Java plugin<br/>
                in upcoming JDK 9
            </li>
        </div>
    </ul>
</section>

<section>
    <h3>Browser Advances</h3>
    <div style="width:15%; right:0px; position:absolute;">
        <img class="plain" style="margin:0px 0px 15px 0px" src="img/javascript.png" />
        <img class="plain" style="margin:0px;"  src="img/webgl.png" />
    </div>
    <ul>
        <li>JavaScript approaches native speed</li>
        <li>WebGL offers plugin-free access<br/>to the graphics card</li>
    </ul>
    <img src="img/webgl-support.png" />
</section>

<section>
    <h3>3D Rendering</h3>
    <ol>
        <li class="inactive">Retrieve File &#10144; MMTF</li>
        <li class="inactive">Parse File &#10144; MMTF</li>
        <li class="inactive">Create Data Model &#10144; Columnar Stores</li>
        <li class="inactive">Create Geometry &#10144; Impostors &amp; Instancing</li>
        <li class="success">Render &#10144; WebGL</li>
    </ol>
</section>



<!-- DOES IT SCALE -->

<section data-state="slide-scale">
    <small>With all that in place</small>
    <h3>Does it scale?</h3>
</section>

<section data-state="slide-3j3q-1">
    <p>
        HIV-1 capsid<br/>
        <small>hexameric subunit, 10800 atoms</small>
    </p>
</section>

<section data-state="slide-3j3q-2">
    <p>
        HIV-1 capsid<br/>
        <small>216 hexameric and 12 pentameric subunit, ~2.4M unique atoms</small>
    </p>
</section>

<section data-state="slide-1m4x">
    <p>
        PBCV-1 virus capsid<br/>
        <small>1680 instances of 9693 atoms (~16M atoms)</small>
    </p>
</section>

<section data-state="slide-5j7v">
    <p>
        Faustovirus major capsid<br/>
        <small>2760 instances of 14478 atoms (~40M atoms)</small>
    </p>
</section>

<section data-state="slide-scale2" class="top">
    <h3>It does scale!</h3>
</section>



<!-- NGL VIEWER -->

<section data-state="slide-ngl">
    <h3>NGL Viewer</h3>
    <small>
        AS Rose &amp; PW Hildebrand.
        <i>NGL Viewer: a web application for molecular visualization.</i><br/>
        Nucl. Acids Res. (1 July 2015) 43 (W1).
        <a href="doi:10.1093/nar/gkv402">doi:10.1093/nar/gkv402</a>
    </small>
    <br/><br/>
    <ul>
        <li>Supports MMTF, uses columnar stores &amp; WebGL</li>
        <li>Openly developed @ <a href="https://github.com/arose/ngl">https://github.com/arose/ngl</a></li>
        <li>Features:
            <ul>
                <li>Electron density maps</li>
            </ul>
        </li>
    </ul>
</section>

<!-- <section>
    <pre><code data-trim data-noescape>
    (def lazy-fib
      (concat
       [0 1]
       <mark>((fn rfib [a b]</mark>
            (lazy-cons (+ a b) (rfib b (+ a b)))) 0 1)))
        </code></pre>
</section> -->



<!-- APPENDIX -->

<section>
    <h3>Acknowledgements</h3>
    <img class="plain" style="width:50%; float:right;"  src="img/rcsb-team.jpg" />
    <ul>
        <li>
            RCSB PDB Team<br/>
            <img class="plain" src="img/rcsb_logo.png" />
        </li>
        <li>
            NCI/NIH<br/>
            (U01 CA198942)<br/>
            <img class="plain" src="img/nih-bd2k.png" />
        </li>
    </ul>
</section>

<section>
    <h3>Thank you for your attention!</h3>
    <br/>
    <h4>Questions?</h4>
    <br/>
    <ul class="inactive">
        <li>Posters: ...</li>
        <li>MMTF: <a href="http://mmtf.rcsb.org">http://mmtf.rcsb.org</a></li>
        <li>NGL Viewer: <a href="https://github.com/arose/ngl">https://github.com/arose/ngl</a></li>
    </ul>
</section>



</div>
</div>

<script src="js/reveal.js"></script>
<script src="js/ngl.js"></script>

<script>
var stage;
document.addEventListener( "DOMContentLoaded", function(){

    Reveal.initialize({
        controls: false,
        showNotes: true,
        width: 960,
        height: 700,
        // width: 1280,
        // height: 933,
    });

    var notesFlag = true;
    function toggleNotes(){
        var elmList = document.querySelectorAll( ".reveal .speaker-notes.visible:not(:empty)" );
        elmList.forEach( function( elm ){
            elm.style.display = notesFlag ? "none" : "block";
        } );
        notesFlag = !notesFlag;
    }
    toggleNotes();
    window.addEventListener( "keyup", function( e ){
        if( e.which === 83 ){
            toggleNotes( notesFlag );
        }
    }, false );

    stage = new NGL.Stage( "viewport", {
        backgroundColor: "white"
    } );
    function handleResize(){
        stage.handleResize();
    }
    window.addEventListener( "resize", handleResize, false );

    stage.tasks.signals.countChanged.add( function( delta, count ){
        document.getElementById( "busy" ).style.display = count > 0 ? "block" : "none";
    } );

    stage.loadFile( "./data/3IYV.mmtf.gz" ).then( function( o ){
        o.addRepresentation( "surface", {
            scaleFactor: 0.1,
            surfaceType: "sas",
            probeRadius: 0.1,
            colorScheme: "atomindex",
            colorScale: "RdYlBu",
            assembly: "BU1",
            useWorker: true,
            visible: true,
            side: "front"
        } );
        var bb = o.structure.biomolDict[ "BU1" ].getBoundingBox( o.structure );
        console.log(bb.size().length(), bb.center())
        stage.viewer.center( bb.center() );
        stage.viewer.zoom( bb.size().length(), true );
    } );

    var _4HHB, _4HHBballnstick, _4HHBcartoon;
    stage.loadFile( "./data/4HHB.mmtf.gz" ).then( function( o ){
        _4HHB = o;
        _4HHBballnstick = _4HHB.addRepresentation( "ball+stick", {
            sele: "142:A.FE",
            assembly: "AU",
            multipleBond: true,
            visible: false
        } );
        _4HHBcartoon = _4HHB.addRepresentation( "cartoon", {
            assembly: "AU",
            visible: false
        } );
    } );

    var _4UJD, _4UJDbackbone, _4UJDsurface;
    stage.loadFile( "./data/4UJD.mmtf.gz" ).then( function( o ){
        _4UJD = o;
        _4UJDsurface = o.addRepresentation( "surface", {
            sele: "nucleic",
            scaleFactor: 0.6,
            surfaceType: "sas",
            probeRadius: 0.1,
            colorScheme: "chainindex",
            colorScale: "RdYlBu",
            useWorker: true,
            visible: false,
            side: "front"
        } );
        _4UJDbackbone = o.addRepresentation( "backbone", {
            sele: "not nucleic",
            scale: 3.0,
            colorScheme: "chainindex",
            colorScale: "RdYlBu",
            visible: false
        } );
    } );

    function centerGroup( group, center ){
        group.children.forEach( function( child ){
            child.position.copy( center );
        } );
    }
    function centerBuffer( buffer, center ){
        centerGroup( buffer.group, center );
        centerGroup( buffer.wireframeGroup, center );
        centerGroup( buffer.pickingGroup, center );
    }
    function centerRepr( reprComp, center ){
        reprComp.repr.bufferList.forEach( function( buffer ){
            centerBuffer( buffer, center );
        } );
    }
    function hideAll(){
        stage.eachComponent( function( comp ){
            comp.setVisibility( false );
        } );
    }

    var _3J3QsubunitSele = ":f0 or :f1 or :f2 or :f3 or :f4 or :f5";
    var _3J3QchainSele = ":f0";

    var _3J3Q, _3J3Qsurface, _3J3Qcartoon, _3J3Qballnstick
    var _1M4X, _1M4Xsurface, _1M4Xcartoon;
    var _5J7V, _5J7Vsurface

    Reveal.addEventListener( "slide-billion", function(){
        hideAll();
    }, false );

    Reveal.addEventListener( "slide-one", function(){
        hideAll();
        _4HHB.setVisibility( true );
        _4HHBballnstick.setSelection( "142:A.FE" );
        _4HHBballnstick.setVisibility( true );
        _4HHBcartoon.setVisibility( false );
        stage.setOrientation( [
            [8.977499961853027,6.925499975681305,-15.964499473571777],
            [-8.905671475448322,17.595168050506715,-13.673454060894326],
            [0.5176488492934739,0.8059486295044971,0.2872045880987358]
        ] );
    }, false );

    Reveal.addEventListener( "slide-group", function(){
        _4HHBballnstick.setVisibility( true );
        _4HHBcartoon.setVisibility( false );
        _4HHBballnstick.setSelection( "142:A" );
        stage.setOrientation( [
            [8.977499961853027,6.925499975681305,-15.964499473571777],
            [-8.905671475448322,17.595168050506715,-13.673454060894326],
            [0.5176488492934739,0.8059486295044971,0.2872045880987358]
        ] );
    }, false );

    Reveal.addEventListener( "slide-protein", function(){
        _4HHBballnstick.setVisibility( false );
        _4HHBcartoon.setVisibility( true );
        _4HHB.centerView();
    }, false );

    Reveal.addEventListener( "slide-complex", function(){
        hideAll();
        _4UJD.setVisibility( true );
        _4UJDsurface.setVisibility( true );
        _4UJDbackbone.setVisibility( true );
        // _4UJD.centerView();
        stage.setOrientation( [
            [-17.98785400390625,8.302421569824219,0.5798568725585938],
            [-253.58287605625114,33.63976044038447,-490.13382486367504],
            [0.6430307052927186,-0.6842075720361525,-0.3440516101097937]
        ] );
    }, false );

    Reveal.addEventListener( "slide-status", function(){
        hideAll();
    }, false );

    function prepareScale(){
        stage.loadFile( "./data/3J3Q.mmtf.gz" ).then( function( o ){
            _3J3Q = o;
            _3J3Qsurface = o.addRepresentation( "surface", {
                scaleFactor: 0.1,
                surfaceType: "sas",
                probeRadius: 0.1,
                colorScheme: "atomindex",
                colorScale: "RdYlBu",
                assembly: "BU1",
                useWorker: true,
                visible: false,
                side: "front"
            } );
            _3J3Qcartoon = o.addRepresentation( "cartoon", {
                sele: _3J3QsubunitSele,
                colorScheme: "chainindex",
                visible: false
            } );
            _3J3Qballnstick = o.addRepresentation( "ball+stick", {
                sele: _3J3QsubunitSele + " and ( sidechainAttached )",
                colorScheme: "element",
                visible: false
            } );
            _3J3Qpoint = o.addRepresentation( "point", {
                visible: false
            } );
            var center = o.structure.center.clone().negate();
            centerRepr( _3J3Qcartoon, center );
            centerRepr( _3J3Qballnstick, center );
            centerRepr( _3J3Qpoint, center );
            _3J3Qsurface.repr.tasks.onZeroOnce( function(){
                centerRepr( _3J3Qsurface, center );
            } );
            console.log(
                "3J3Q",
                _3J3Qcartoon.repr.structureView.atomCount,
                _3J3Q.structure.atomCount,
                _3J3Q.structure.biomolDict[ "BU1" ].getAtomCount( _3J3Q.structure ),
                _3J3Q.structure.biomolDict[ "BU1" ].getInstanceCount()
            );
        } );
        stage.loadFile( "./data/1M4X.mmtf.gz" ).then( function( o ){
            _1M4X = o;
            _1M4Xsurface = o.addRepresentation( "surface", {
                scaleFactor: 0.1,
                surfaceType: "sas",
                probeRadius: 0.1,
                colorScheme: "atomindex",
                colorScale: "RdYlBu",
                assembly: "BU1",
                useWorker: true,
                visible: false,
                side: "front"
            } );
            console.log(
                "1M4X",
                _1M4X.structure.atomCount,
                _1M4X.structure.biomolDict[ "BU1" ].getAtomCount( _1M4X.structure ),
                _1M4X.structure.biomolDict[ "BU1" ].getInstanceCount()
            );
        } );
        stage.loadFile( "./data/5J7V.mmtf.gz" ).then( function( o ){
            _5J7V = o;
            _5J7Vsurface = o.addRepresentation( "surface", {
                scaleFactor: 0.05,
                surfaceType: "sas",
                probeRadius: 0.1,
                colorScheme: "atomindex",
                colorScale: "RdYlBu",
                assembly: "BU1",
                useWorker: true,
                visible: false,
                side: "front"
            } );
            console.log(
                "5J7V",
                _5J7V.structure.atomCount,
                _5J7V.structure.biomolDict[ "BU1" ].getAtomCount( _5J7V.structure ),
                _5J7V.structure.biomolDict[ "BU1" ].getInstanceCount()
            );
        } );
    }

    prepareScale();
    Reveal.addEventListener( "slide-scale", function(){
        hideAll();
    }, false );

    var viewer = stage.viewer;
    var controls = viewer.controls;
    var camera = viewer.camera;

    var target = new NGL.Vector3();
    var target0 = new NGL.Vector3();
    var targetN = new NGL.Vector3();

    Reveal.addEventListener( "slide-3j3q-1", function(){
        hideAll();
        _3J3Q.setVisibility( true );
        _3J3Qsurface.setVisibility( false );
        _3J3Qcartoon.setVisibility( true );
        _3J3Qballnstick.setVisibility( true );
        _3J3Qpoint.setVisibility( false );

        var selection = new NGL.Selection( _3J3QsubunitSele );
        var bb = _3J3Q.structure.getBoundingBox( selection );

        target.copy( _3J3Q.structure.atomCenter( selection ) );
        viewer.center( target.sub( _3J3Q.structure.center ) );
        viewer.zoom( _3J3Q.structure.getBoundingBox( selection ).size().length(), true );
        stage.setSpin( [ 0, 1, 0 ], 0.005 );

    }, false );

    Reveal.addEventListener( "slide-3j3q-2", function(){
        _3J3Qsurface.setVisibility( false );
        _3J3Qcartoon.setVisibility( true );
        _3J3Qballnstick.setVisibility( true );
        _3J3Qpoint.setVisibility( true );
        _3J3Q.setVisibility( true );
        _1M4X.setVisibility( false );
        _5J7V.setVisibility( false );
        stage.setSpin( null );

        var selection = new NGL.Selection( _3J3QsubunitSele );
        target0.copy( controls.target );

        var zoom0 = _3J3Q.structure.getBoundingBox( selection ).size().length();
        var zoomN = _3J3Q.structure.getBoundingBox().size().length();

        var t0 = performance.now();
        function animate(){
            var delta = performance.now() - t0;
            var alpha = Math.min( 1.0, delta / 5000 );
            // _3J3Qsurface.setParameters( { opacity: alpha } );
            target.lerpVectors( target0, targetN, alpha );
            viewer.center( target );
            viewer.zoom( zoom0 + ( zoomN - zoom0 ) * alpha, true );
            viewer.requestRender();
            if( alpha < 1.0 ){
                requestAnimationFrame( animate );
            }else{
                // stage.setSpin( [ 0, 1, 0 ], 0.005 );
                stage.setSpin( null );
                _3J3Qsurface.setVisibility( true );
                t0 = performance.now();
                animate2();
            }
        }
        function animate2(){
            var delta = performance.now() - t0;
            var alpha = Math.min( 1.0, delta / 5000 );
            _3J3Qsurface.setParameters( { opacity: alpha } );
            viewer.requestRender();
            if( alpha < 1.0 ){
                requestAnimationFrame( animate2 );
            }else{
                stage.setSpin( [ 0, 1, 0 ], 0.005 );
            }
        }
        animate();

    }, false );

    Reveal.addEventListener( "slide-1m4x", function(){
        _3J3Qsurface.setVisibility( true );
        _1M4Xsurface.setVisibility( true );
        _5J7Vsurface.setVisibility( false );
        _3J3Q.setVisibility( true );
        _1M4X.setVisibility( true );
        _5J7V.setVisibility( false );
        stage.setSpin( null );

        var zoom0 = _3J3Q.structure.getBoundingBox().size().length();
        var zoomN = _1M4X.structure.biomolDict[ "BU1" ].getBoundingBox( _1M4X.structure ).size().length();

        var t0 = performance.now();
        function animate(){
            var delta = performance.now() - t0;
            var alpha = Math.min( 1.0, delta / 5000 );
            _1M4Xsurface.setParameters( { opacity: alpha } );
            viewer.zoom( zoom0 + ( zoomN - zoom0 ) * alpha, true );
            viewer.requestRender();
            if( alpha < 1.0 ){
                requestAnimationFrame( animate );
            }else{
                stage.setSpin( [ 0, 1, 0 ], 0.005 );
            }
        }
        animate();

    }, false );

    Reveal.addEventListener( "slide-5j7v", function(){
        _3J3Qsurface.setVisibility( true );
        _1M4Xsurface.setVisibility( true );
        _5J7Vsurface.setVisibility( true );
        _3J3Q.setVisibility( true );
        _1M4X.setVisibility( true );
        _5J7V.setVisibility( true );
        stage.setSpin( null );

        var zoom0 = _1M4X.structure.biomolDict[ "BU1" ].getBoundingBox( _1M4X.structure ).size().length();
        var zoomN = _5J7V.structure.biomolDict[ "BU1" ].getBoundingBox( _5J7V.structure ).size().length();

        var t0 = performance.now();
        function animate(){
            var delta = performance.now() - t0;
            var alpha = Math.min( 1.0, delta / 5000 );
            _5J7Vsurface.setParameters( { opacity: alpha } );
            viewer.zoom( zoom0 + ( zoomN - zoom0 ) * alpha, true );
            viewer.requestRender();
            if( alpha < 1.0 ){
                requestAnimationFrame( animate );
            }else{
                stage.setSpin( [ 0, 1, 0 ], 0.005 );
            }
        }
        animate();

    }, false );

    Reveal.addEventListener( "slide-scale2", function(){
        _3J3Qsurface.setVisibility( true );
        _1M4Xsurface.setVisibility( true );
        _5J7Vsurface.setVisibility( true );
        _3J3Qsurface.setParameters( { side: "double" } );
        _1M4Xsurface.setParameters( { side: "double" } );
        _5J7Vsurface.setParameters( { side: "double" } );
        _3J3Q.setVisibility( true );
        _1M4X.setVisibility( true );
        _5J7V.setVisibility( true );

        var t0 = performance.now();
        function animate(){
            var delta = performance.now() - t0;
            var alpha = Math.min( 1.0, delta / 5000 );
            stage.setParameters( { clipNear: 50 * alpha } );
            viewer.requestRender();
            if( alpha < 1.0 ){
                requestAnimationFrame( animate );
            }else{
                stage.setSpin( null );
            }
        }
        animate();

    }, false );

} );
</script>

</body>
</html>